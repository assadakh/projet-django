<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Pentest</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        section {
            margin: 20px 0;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        label {
            font-weight: bold;
            margin-right: 10px;
        }
        input {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .logout-button {
            background-color: #dc3545;
            float: right;
            margin-bottom: 20px;
        }
        .logout-button:hover {
            background-color: #c82333;
        }
        div[id$="Results"], div[id$="History"] {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .loading {
            color: #007bff;
            font-style: italic;
        }
        .error {
            color: red;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        .pagination {
            margin-top: 10px;
            text-align: center;
        }
        .pagination button {
            margin: 0 5px;
        }
        .scan-details {
            display: none;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }
        .scan-row {
            cursor: pointer;
        }
        .scan-row:hover {
            background-color: #f0f0f0;
        }
        .search-container {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <button class="logout-button" onclick="logout()">Déconnexion</button>
    <h1>Dashboard Pentest</h1>

    <!-- Section Nmap -->
    <section>
        <label for="ipInput">IP pour Nmap :</label>
        <input type="text" id="ipInput" placeholder="Ex: 192.168.1.1" />
        <button onclick="launchScan('nmap', 'ipInput', 'nmapResults', '/api/nmapscan/')">Lancer Nmap</button>
        <div id="nmapLoading" class="loading" style="display: none;">Chargement...</div>
        <div id="nmapResults"></div>
        <p></p>
        <div class="search-container">
            <label for="nmapSearch">Rechercher IP :</label>
            <input type="text" id="nmapSearch" placeholder="Ex: 192.168.1.1" oninput="searchScans('nmap')" />
        </div>
        <div id="nmapHistoryLoading" class="loading" style="display: none;">Chargement de l'historique...</div>
        <div id="nmapHistory"></div>
    </section>
    
    <!-- Section WhatWeb -->
    <section>
        <label for="urlWhatWebInput">URL pour WhatWeb :</label>
        <input type="text" id="urlWhatWebInput" placeholder="https://exemple.com" />
        <button onclick="launchScan('whatweb', 'urlWhatWebInput', 'whatwebResults', '/api/whatwebscan/')">Lancer WhatWeb</button>
        <div id="whatwebLoading" class="loading" style="display: none;">Chargement...</div>
        <div id="whatwebResults"></div>
        <p></p>
        <div class="search-container">
            <label for="whatwebSearch">Rechercher URL :</label>
            <input type="text" id="whatwebSearch" placeholder="https://exemple.com" oninput="searchScans('whatweb')" />
        </div>
        <div id="whatwebHistoryLoading" class="loading" style="display: none;">Chargement de l'historique...</div>
        <div id="whatwebHistory"></div>
    </section>

    <!-- Section ZAP -->
    <section>
        <label for="urlZapInput">URL pour ZAP :</label>
        <input type="text" id="urlZapInput" placeholder="https://exemple.com" />
        <button onclick="launchScan('zap', 'urlZapInput', 'zapResults', '/api/zapscan/')">Lancer ZAP</button>
        <div id="zapLoading" class="loading" style="display: none;">Chargement...</div>
        <div id="zapResults"></div>
        <p></p>
        <div class="search-container">
            <label for="zapSearch">Rechercher URL :</label>
            <input type="text" id="zapSearch" placeholder="https://exemple.com" oninput="searchScans('zap')" />
        </div>
        <div id="zapHistoryLoading" class="loading" style="display: none;">Chargement de l'historique...</div>
        <div id="zapHistory"></div>
    </section>

    <script>
        async function refreshToken() {
            try {
                const response = await fetch('/api/token/refresh/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh: localStorage.getItem('refreshToken') })
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('accessToken', data.access);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Erreur lors du rafraîchissement du token:', error);
                return false;
            }
        }

        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            window.location.href = '/login';
        }

        function isValidIP(ip) {
            const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            return ipRegex.test(ip);
        }

        function isValidURL(url) {
            const urlRegex = /^(https?:\/\/)?([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(\/.*)?$/;
            return urlRegex.test(url);
        }

        async function launchScan(tool, inputId, resultsId, endpoint) {
            const input = document.getElementById(inputId).value;
            const resultsDiv = document.getElementById(resultsId);
            const loadingDiv = document.getElementById(`${tool}Loading`);
            const isIP = tool === 'nmap';

            if (!input || (isIP && !isValidIP(input)) || (!isIP && !isValidURL(input))) {
                resultsDiv.innerHTML = `<p class="error">Veuillez saisir une ${isIP ? 'IP' : 'URL'} valide</p>`;
                return;
            }

            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';

            try {
                let resp = await fetch(`${endpoint}?${isIP ? 'ip' : 'url'}=${encodeURIComponent(input)}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                    }
                });

                if (resp.status === 401) {
                    const refreshed = await refreshToken();
                    if (refreshed) {
                        resp = await fetch(`${endpoint}?${isIP ? 'ip' : 'url'}=${encodeURIComponent(input)}`, {
                            headers: {
                                'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                            }
                        });
                    } else {
                        alert('Session expirée. Veuillez vous reconnecter.');
                        window.location.href = '/login';
                        return;
                    }
                }

                if (!resp.ok) {
                    const errorText = await resp.text();
                    throw new Error(`Erreur HTTP ${resp.status}: ${errorText || 'Aucune information supplémentaire'}`);
                }

                let data;
                try {
                    data = await resp.json();
                } catch (jsonError) {
                    const errorText = await resp.text();
                    throw new Error(`Erreur de parsing JSON: ${jsonError.message}. Réponse brute: ${errorText || 'Vide'}`);
                }

                loadingDiv.style.display = 'none';

                if (data.error) {
                    resultsDiv.innerHTML = `<p class="error">${data.error}</p>`;
                    return;
                }

                let html = `<h3>Résultats ${tool.toUpperCase()} pour ${data[isIP ? 'ip' : 'url']}</h3><ul>`;
                data.scans.forEach(item => {
                    if (tool === 'nmap') {
                        html += `<li>Port ${item.port} - ${item.state} - Service: ${item.service}</li>`;
                    } else if (tool === 'whatweb') {
                        html += `<li>${item}</li>`;
                    } else if (tool === 'zap') {
                        html += `<li><strong>${item.alert}</strong> - Risque: ${item.risk} - ${item.description}</li>`;
                    }
                });
                html += '</ul>';
                resultsDiv.innerHTML = html;

                // Rafraîchir l'historique après un nouveau scan
                fetchScanHistory(tool);
            } catch (error) {
                loadingDiv.style.display = 'none';
                resultsDiv.innerHTML = `<p class="error">Erreur: ${error.message}</p>`;
            }
        }

        let currentPage = { nmap: 1, whatweb: 1, zap: 1 };
        const scansPerPage = 10;
        let allScans = { nmap: [], whatweb: [], zap: [] }; // Cache des scans pour la recherche

        async function fetchScanHistory(type) {
            const resultsDiv = document.getElementById(`${type}History`);
            const loadingDiv = document.getElementById(`${type}HistoryLoading`);
            const searchInput = document.getElementById(`${type}Search`).value.toLowerCase();
            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';

            try {
                // Récupérer toutes les pages pour avoir tous les scans
                let allData = [];
                let page = 1;
                let hasMore = true;
                while (hasMore) {
                    let resp = await fetch(`/api/scan_history/?type=${type}&page=${page}&limit=${scansPerPage}`, {
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                        }
                    });

                    if (resp.status === 401) {
                        const refreshed = await refreshToken();
                        if (refreshed) {
                            resp = await fetch(`/api/scan_history/?type=${type}&page=${page}&limit=${scansPerPage}`, {
                                headers: {
                                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                                }
                            });
                        } else {
                            alert('Session expirée. Veuillez vous reconnecter.');
                            window.location.href = '/login';
                            return;
                        }
                    }

                    if (!resp.ok) {
                        throw new Error(`Erreur HTTP ${resp.status}`);
                    }

                    const data = await resp.json();
                    allData = allData.concat(data.scans);
                    hasMore = page < data.pages;
                    page++;
                }

                // Stocker les scans dans le cache
                allScans[type] = allData;

                // Filtrer les scans par recherche
                const filteredScans = searchInput
                    ? allScans[type].filter(scan => (scan.ip || scan.url).toLowerCase().includes(searchInput))
                    : allScans[type];

                // Regrouper les scans par IP/URL
                const groupedScans = {};
                filteredScans.forEach(scan => {
                    const key = scan.ip || scan.url;
                    if (!groupedScans[key]) {
                        groupedScans[key] = {
                            scans: [],
                            latestDate: scan.date_scan
                        };
                    }
                    groupedScans[key].scans.push(scan);
                    if (scan.date_scan && new Date(scan.date_scan) > new Date(groupedScans[key].latestDate)) {
                        groupedScans[key].latestDate = scan.date_scan;
                    }
                });

                // Paginer les résultats groupés
                const groupedKeys = Object.keys(groupedScans);
                const totalPages = Math.ceil(groupedKeys.length / scansPerPage);
                const start = (currentPage[type] - 1) * scansPerPage;
                const paginatedKeys = groupedKeys.slice(start, start + scansPerPage);

                let html = `<h3>Historique ${type.toUpperCase()}</h3>`;
                if (paginatedKeys.length === 0) {
                    html += `<p>Aucun résultat trouvé.</p>`;
                } else {
                    html += `<table><tr><th>Date</th><th>${type === 'nmap' ? 'IP' : 'URL'}</th><th>Action</th></tr>`;
                    paginatedKeys.forEach(key => {
                        const scans = groupedScans[key].scans;
                        const latestDate = groupedScans[key].latestDate;
                        const formattedDate = latestDate && !isNaN(new Date(latestDate)) 
                            ? new Date(latestDate).toLocaleString('fr-FR') 
                            : 'Date non disponible';
                        html += `<tr class="scan-row" onclick="toggleDetails('${type}', '${key.replace(/'/g, "\\'")}')">
                            <td>${formattedDate}</td>
                            <td>${key}</td>
                            <td><button onclick="deleteScanGroup('${type}', '${key.replace(/'/g, "\\'")}'); event.stopPropagation();">Supprimer</button></td>
                        </tr>`;
                        html += `<tr id="${type}-${key.replace(/[^a-zA-Z0-9]/g, '-')}-details" class="scan-details"><td colspan="3"><div>`;
                        if (type === 'whatweb') {
                            html += `<ul>`;
                            scans.forEach(scan => {
                                console.log(`WhatWeb result for ${key}:`, scan.result);
                                const results = scan.result ? scan.result.split(',').map(item => item.trim()).filter(item => item) : [];
                                results.forEach(result => {
                                    html += `<li>${result}</li>`;
                                });
                            });
                            html += `</ul>`;
                        } else {
                            html += `<ul>`;
                            scans.forEach(scan => {
                                if (type === 'nmap') {
                                    html += `<li>Port ${scan.port}/${scan.protocol} - ${scan.state} - Service: ${scan.service}</li>`;
                                } else if (type === 'zap') {
                                    html += `<p><strong>${scan.alert}</strong> - Risque: ${scan.risk} - ${scan.description}</p>`;
                                }
                            });
                            html += `</ul>`;
                        }
                        html += `</div></td></tr>`;
                    });
                    html += `</table>`;
                }
                html += `<div class="pagination">
                    <button onclick="previousPage('${type}')">Précédent</button>
                    <span>Page ${currentPage[type]} / ${totalPages}</span>
                    <button onclick="nextPage('${type}', ${totalPages})">Suivant</button>
                </div>`;
                resultsDiv.innerHTML = html;
                loadingDiv.style.display = 'none';
            } catch (error) {
                loadingDiv.style.display = 'none';
                resultsDiv.innerHTML = `<p class="error">Erreur: ${error.message}</p>`;
            }
        }

        function toggleDetails(type, key) {
            const detailsRow = document.getElementById(`${type}-${key.replace(/[^a-zA-Z0-9]/g, '-')}-details`);
            detailsRow.style.display = detailsRow.style.display === 'table-row' ? 'none' : 'table-row';
        }

        async function deleteScanGroup(type, key) {
            try {
                let resp = await fetch(`/api/delete_scan/?type=${type}&${type === 'nmap' ? 'ip' : 'url'}=${encodeURIComponent(key)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                    }
                });

                if (resp.status === 401) {
                    const refreshed = await refreshToken();
                    if (refreshed) {
                        resp = await fetch(`/api/delete_scan/?type=${type}&${type === 'nmap' ? 'ip' : 'url'}=${encodeURIComponent(key)}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                            }
                        });
                    } else {
                        alert('Session expirée. Veuillez vous reconnecter.');
                        window.location.href = '/login';
                        return;
                    }
                }

                if (!resp.ok) {
                    throw new Error(`Erreur HTTP ${resp.status}`);
                }

                const data = await resp.json();
                if (data.message) {
                    currentPage[type] = 1; // Réinitialiser la page après suppression
                    fetchScanHistory(type);
                }
            } catch (error) {
                document.getElementById(`${type}History`).innerHTML = `<p class="error">Erreur: ${error.message}</p>`;
            }
        }

        function searchScans(type) {
            currentPage[type] = 1; // Réinitialiser la page lors de la recherche
            fetchScanHistory(type);
        }

        function previousPage(type) {
            if (currentPage[type] > 1) {
                currentPage[type]--;
                fetchScanHistory(type);
            }
        }

        function nextPage(type, totalPages) {
            if (currentPage[type] < totalPages) {
                currentPage[type]++;
                fetchScanHistory(type);
            }
        }

        // Charger l'historique au démarrage
        document.addEventListener('DOMContentLoaded', () => {
            fetchScanHistory('nmap');
            fetchScanHistory('whatweb');
            fetchScanHistory('zap');
        });
    </script>
</body>
</html>